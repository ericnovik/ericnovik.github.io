<!DOCTYPE html>
<html lang="en"><head>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/tabby.min.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.40">

  <meta name="author" content="Eric Novik | Spring 2024 | Lecture 5">
  <title>Eric Novik – Bayesian Inference</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/theme/quarto-f1dfd3a0977a76e2a9d8c22d888bc8cb.css">
  <link href="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Bayesian Inference</h1>
  <p class="subtitle">NYU Applied Statistics for Social Science Research</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Eric Novik | Spring 2024 | Lecture 5 
</div>
</div>
</div>

</section>
<section id="homework-feedback" class="slide level2">
<h2>Homework Feedback</h2>

<img data-src="images/scared.avif" class="quarto-figure quarto-figure-center r-stretch" width="672"><p><a href="https://www.polleverywhere.com/multiple_choice_polls/XRXD5GmcXM8v0XyE7tgIT">How was Homework 4?</a></p>
</section>
<section id="bayesian-linear-regression-and-model-evaluation" class="slide level2">
<h2>Bayesian linear regression and model evaluation</h2>
<div class="columns">
<div class="column" style="width:60%;">
<div>
<ul>
<li class="fragment">Introducing linear regression</li>
<li class="fragment">Prior predictive simulations</li>
<li class="fragment">Sampling from the posterior</li>
<li class="fragment">Example of linear regression in Stan</li>
<li class="fragment">Evaluating the quality of the draws</li>
<li class="fragment">Posterior predictions</li>
<li class="fragment">Cross-validation, ELPD, and LOO</li>
</ul>
</div>
</div><div class="column" style="width:40%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/stan.png" class="quarto-figure quarto-figure-center" height="500"></p>
</figure>
</div>
</div></div>
<p><span class="math display">\[
\DeclareMathOperator{\E}{\mathbb{E}}
\DeclareMathOperator{\P}{\mathbb{P}}
\DeclareMathOperator{\V}{\mathbb{V}}
\DeclareMathOperator{\L}{\mathcal{L}}
\DeclareMathOperator{\I}{\text{I}}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\]</span></p>
</section>
<section id="motivating-example" class="slide level2 smaller">
<h2>Motivating Example</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div>
<ul>
<li class="fragment">We borrow this example from Richard McElreath’s Statistical Rethinking</li>
<li class="fragment">The data sets provided have been produced between 1969 to 2008, based on Nancy Howell’s observations of the !Kung San</li>
<li class="fragment">From Wikipedia: “The ǃKung are one of the San peoples who live mostly on the western edge of the Kalahari desert, Ovamboland (northern Namibia and southern Angola), and Botswana.”</li>
</ul>
</div>
</div><div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-right">
<figure>
<p><img data-src="images/kalahari.png" class="quarto-figure quarto-figure-right"></p>
</figure>
</div>
</div></div>
<div class="footer">
<p><a href="https://tspace.library.utoronto.ca/handle/1807/10395">Univercity of Toronto Data Sets</a></p>
</div>
</section>
<section id="howell-dataset" class="slide level2 smaller">
<h2>Howell Dataset</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="fragment">
<ul>
<li>Data sample and summary:</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: right;">height</th>
<th style="text-align: right;">weight</th>
<th style="text-align: right;">age</th>
<th style="text-align: right;">male</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">151.765</td>
<td style="text-align: right;">47.82561</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">139.700</td>
<td style="text-align: right;">36.48581</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">136.525</td>
<td style="text-align: right;">31.86484</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">156.845</td>
<td style="text-align: right;">53.04191</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">145.415</td>
<td style="text-align: right;">41.27687</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">163.830</td>
<td style="text-align: right;">62.99259</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>     height           weight            age       
 Min.   : 53.98   Min.   : 4.252   Min.   : 0.00  
 1st Qu.:125.09   1st Qu.:22.008   1st Qu.:12.00  
 Median :148.59   Median :40.058   Median :27.00  
 Mean   :138.26   Mean   :35.611   Mean   :29.34  
 3rd Qu.:157.48   3rd Qu.:47.209   3rd Qu.:43.00  
 Max.   :179.07   Max.   :62.993   Max.   :88.00  </code></pre>
</div>
</div>
</div>
</div><div class="column" style="width:50%;">
<div class="fragment">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-3-1.png" class="quarto-figure quarto-figure-center" width="432"></p>
</figure>
</div>
</div>
</div>
</div>
<div>
<ul>
<li class="fragment">Notice a non-linearity</li>
<li class="fragment">Thinking about why this should be, can give you an insight into how to model these data</li>
</ul>
</div>
</div></div>
</section>
<section id="howell-dataset-1" class="slide level2 smaller">
<h2>Howell Dataset</h2>
<div>
<ul>
<li class="fragment">For now, we will focus on the linear subset of the data</li>
<li class="fragment">We will demonstrate the non-linear model at the end</li>
<li class="fragment">We will restrict our attention to adults (age &gt; 18)</li>
</ul>
</div>
<div class="fragment">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-4-1.png" class="quarto-figure quarto-figure-center" width="480"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="general-approach" class="slide level2 smaller scrollable">
<h2>General Approach</h2>
<div>
<ol type="1">
<li class="fragment">Assess the scope of the inferences that you will get with this model</li>
<li class="fragment">Unless you are doing causal inference, you should interpret your coefficients as comparisons (RAOS, Page 84)</li>
<li class="fragment">Set up reasonable priors and likelihood</li>
<li class="fragment">For more complex models, perform a forward simulation with fixed parameter values and try to recover them by running an inference algorithm. See <a href="https://www.generable.com/post/fitting-a-basic-sir-model-in-stan">this</a> example for a standard epidemiological model.</li>
<li class="fragment">Perform a prior predictive simulation</li>
<li class="fragment">Possibly adjust your priors</li>
<li class="fragment">Fit the model to data</li>
<li class="fragment">Assess the quality of the inference and the quality of the model</li>
<li class="fragment">Improve or fix your model and go back to #3</li>
</ol>
</div>
</section>
<section id="howell-regression" class="slide level2 smaller">
<h2>Howell Regression</h2>
<div>
<ul>
<li class="fragment">We will build a predictive model for adult Weight <span class="math inline">\(y\)</span> given Height <span class="math inline">\(x\)</span> using the Howell dataset</li>
<li class="fragment">Initial stab at the model: <span class="math display">\[
\begin{eqnarray}
y_i &amp; \sim &amp; \text{Normal}(\mu_i, \, \sigma)\\
\mu_i &amp; = &amp; \alpha + \beta x_i \\
\alpha &amp; \sim &amp; \text{Normal}(\alpha_{l}, \, \alpha_s) \\
\beta &amp; \sim &amp; \text{Normal}(\beta_{l}, \, \beta_s) \\
\sigma &amp; \sim &amp; \text{Exp}(r) \\
\end{eqnarray}
\]</span></li>
<li class="fragment">We have to specify <span class="math inline">\(\alpha_{l}\)</span> and <span class="math inline">\(\alpha_s\)</span>, where l and s signify location and scale, and r, the rate of the exponential</li>
<li class="fragment">If we work on the original scale for <span class="math inline">\(x\)</span>, it is awkward to choose a prior for the intercept : it corresponds to the weight of the person with zero height</li>
<li class="fragment">This can be fixed by subtracting the average height from <span class="math inline">\(x\)</span></li>
<li class="fragment">Why is <span class="math inline">\(\text{Exp}(r)\)</span> is a reasonable prior for <span class="math inline">\(\sigma\)</span>?</li>
</ul>
</div>
</section>
<section id="howell-regression-1" class="slide level2 smaller">
<h2>Howell Regression</h2>
<div>
<ul>
<li class="fragment">We define a new variable, the centered version of <span class="math inline">\(x\)</span>: <span class="math inline">\(x^c_i = x_i - \bar{x}\)</span></li>
<li class="fragment">Now <span class="math inline">\(\alpha\)</span> corresponds to the weight of an average person</li>
<li class="fragment">Checking <a href="https://en.wikipedia.org/wiki/Human_body_weight">Wikipedia</a> reveals that the average weight of a person in Africa is about 60 kg</li>
<li class="fragment">They don’t state the standard deviation, but it is unlikely that an African adult would weigh less than 30 kg and more than 120 kg so we will set the prior sd = 10 <span class="math display">\[
\begin{eqnarray}
y_i &amp; \sim &amp; \text{Normal}(\mu_i, \, \sigma)\\
\mu_i &amp; = &amp; \alpha + \beta x^c_i \\
\alpha &amp; \sim &amp; \text{Normal}(60, \, 10) \\
\beta &amp; \sim &amp; \text{Normal}(\beta_{l}, \, \beta_s) \\
\sigma &amp; \sim &amp; \text{Exp}(r) \\
\end{eqnarray}
\]</span></li>
<li class="fragment">What about the slope <span class="math inline">\(\beta\)</span>?</li>
</ul>
</div>
</section>
<section id="howell-regression-2" class="slide level2 smaller">
<h2>Howell Regression</h2>
<div>
<ul>
<li class="fragment">In this dataset, the units of <span class="math inline">\(\beta\)</span> are <span class="math inline">\(\frac{kg}{cm}\)</span>, since the units of height are <span class="math inline">\(cm\)</span></li>
<li class="fragment">First thing, <span class="math inline">\(\beta\)</span> should be positive. Why?</li>
<li class="fragment">Second, <span class="math inline">\(\beta\)</span> is likely less than 1. Why?</li>
<li class="fragment">We can consult <a href="http://socr.ucla.edu/docs/resources/SOCR_Data/SOCR_Data_Dinov_020108_HeightsWeights.html">height-weight tables</a> for the expected value and variance</li>
<li class="fragment">In the dataset, <span class="math inline">\(\E(\beta) = 0.55\)</span> with a standard error of 0.006, but since we are uncertain how applicable that is to !Kung, we will allow the prior to vary more <span class="math display">\[
\begin{eqnarray}
y_i &amp; \sim &amp; \text{Normal}(\mu_i, \, \sigma)\\
\mu_i &amp; = &amp; \alpha + \beta x^c_i \\
\alpha &amp; \sim &amp; \text{Normal}(60, \, 10) \\
\beta &amp; \sim &amp; \text{Normal}(0.55, \, 0.1) \\
\sigma &amp; \sim &amp; \text{Exp}(r) \\
\end{eqnarray}
\]</span></li>
<li class="fragment">What about the error term <span class="math inline">\(\sigma\)</span>?</li>
</ul>
</div>
</section>
<section id="howell-regression-3" class="slide level2 smaller">
<h2>Howell Regression</h2>
<div>
<ul>
<li class="fragment">We know that <span class="math inline">\(\sigma\)</span> must be positive, so a possible choice for the prior is <span class="math inline">\(\text{Normal}^+\)</span>, Exponential, etc.</li>
<li class="fragment">At this stage, the key is to rule out implausible values, not to get something precise, particularly since we have enough data (&gt; 340 observations)</li>
<li class="fragment">From the background data, the residual standard error was 4.6, which implies the exponential rate parameter of about 1/5 <span class="math display">\[
\begin{eqnarray}
y_i &amp; \sim &amp; \text{Normal}(\mu_i, \, \sigma)\\
\mu_i &amp; = &amp; \alpha + \beta x^c_i \\
\alpha &amp; \sim &amp; \text{Normal}(60, \, 10) \\
\beta &amp; \sim &amp; \text{Normal}(0.55, \, 0.1) \\
\sigma &amp; \sim &amp; \text{Exp}(0.2) \\
\end{eqnarray}
\]</span></li>
<li class="fragment">We are now ready to perform a prior predictive simulation</li>
</ul>
</div>
</section>
<section id="prior-predictive-simulation" class="slide level2 smaller">
<h2>Prior Predictive Simulation</h2>
<div>
<ul>
<li class="fragment">The simulation follows the generative process defined by the model</li>
</ul>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a></a>  <span class="fu">mutate</span>(<span class="at">height_c =</span> height <span class="sc">-</span> <span class="fu">mean</span>(height))</span>
<span id="cb2-3"><a></a><span class="fu">round</span>(<span class="fu">mean</span>(d<span class="sc">$</span>height_c), <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a></a><span class="fu">head</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  height weight   age  male height_c
   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1   152.   47.8    63     1    -2.83
2   140.   36.5    63     0   -14.9 
3   137.   31.9    65     0   -18.1 
4   157.   53.0    41     1     2.25
5   145.   41.3    51     0    -9.18
6   164.   63.0    35     1     9.23</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a></a>prior_pred <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb6-2"><a></a>  alpha <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">60</span>, <span class="dv">10</span>)</span>
<span id="cb6-3"><a></a>  beta <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="fl">0.55</span>, <span class="fl">0.1</span>)</span>
<span id="cb6-4"><a></a>  sigma <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb6-5"><a></a>  l <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data); y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(l)</span>
<span id="cb6-6"><a></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>l) {</span>
<span id="cb6-7"><a></a>    mu <span class="ot">&lt;-</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> data<span class="sc">$</span>height_c[i]</span>
<span id="cb6-8"><a></a>    y[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu, sigma)</span>
<span id="cb6-9"><a></a>  }</span>
<span id="cb6-10"><a></a>  <span class="fu">return</span>(y)</span>
<span id="cb6-11"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div><div class="column" style="width:50%;">
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb7-2"><a></a>pr_p <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="at">n =</span> n, <span class="fu">prior_pred</span>(d))</span>
<span id="cb7-3"><a></a><span class="co"># using library(purrr) functional primitives:</span></span>
<span id="cb7-4"><a></a><span class="co"># pr_p &lt;- map(1:n, \(i) prior_pred(d))</span></span>
<span id="cb7-5"><a></a><span class="fu">dim</span>(pr_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 352 100</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a></a><span class="fu">round</span>(pr_p[<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>], <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]  [,3]   [,4]  [,5]  [,6]  [,7]  [,8]
 [1,] 75.17 45.38 63.41  79.34 70.60 53.38 59.64 71.54
 [2,] 66.90 43.28 60.23  56.40 64.75 45.41 52.28 61.20
 [3,] 58.87 32.81 34.94  71.38 63.30 73.13 66.56 61.37
 [4,] 64.57 47.99 73.31  40.31 72.81 52.06 29.27 79.36
 [5,] 69.54 41.90 61.59  -4.10 66.94 60.39 44.22 72.73
 [6,] 85.82 53.97 68.87 104.92 76.18 60.51 56.68 76.91
 [7,] 62.48 51.62 68.41  25.53 69.20 64.53 70.15 70.65
 [8,] 77.69 62.25 72.45  63.32 78.10 67.48 63.22 81.76
 [9,] 80.35 43.70 54.51  13.69 68.65 46.92 48.20 70.36
[10,] 85.94 51.44 66.29 111.06 76.71 64.20 53.96 78.94
[11,] 85.61 41.28 53.84  60.63 71.72 83.42 47.55 76.78
[12,] 74.94 55.23 61.77  34.21 70.00 53.53 59.05 68.94</code></pre>
</div>
</div>
</div>
</div></div>
</section>
<section id="prior-predictive-simulation-1" class="slide level2 smaller">
<h2>Prior Predictive Simulation</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a></a>data_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(d<span class="sc">$</span>weight)</span>
<span id="cb11-2"><a></a>mean_dist <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(pr_p)</span>
<span id="cb11-3"><a></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(data_mean, mean_dist), <span class="fu">aes</span>(mean_dist)) <span class="sc">+</span></span>
<span id="cb11-4"><a></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb11-5"><a></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> data_mean, <span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a></a>  <span class="fu">xlab</span>(<span class="st">"Distribution of Weight means (kg) under the prior"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb11-7"><a></a>  <span class="fu">theme</span>(<span class="at">axis.title.y=</span><span class="fu">element_blank</span>(), <span class="at">axis.text.y=</span><span class="fu">element_blank</span>(), <span class="at">axis.ticks.y=</span><span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-7-1.png" class="quarto-figure quarto-figure-center r-stretch" width="384"></section>
<section id="prior-predictive-simulation-2" class="slide level2 smaller">
<h2>Prior Predictive Simulation</h2>
<div>
<ul>
<li class="fragment">To get a sense for the possible regression lines implied by the prior, we can fit a linear model to each simulation draw, and plot the lines over observations</li>
</ul>
</div>
<div class="fragment">
<div class="cell columns column-output-location" data-layout-align="center">
<div class="column">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a></a>intercepts <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb12-2"><a></a>slopes <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb12-3"><a></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb12-4"><a></a>  coefs <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(pr_p[, i] <span class="sc">~</span> d<span class="sc">$</span>height_c))</span>
<span id="cb12-5"><a></a>  intercepts[i] <span class="ot">&lt;-</span> coefs[<span class="dv">1</span>]</span>
<span id="cb12-6"><a></a>  slopes[i] <span class="ot">&lt;-</span> coefs[<span class="dv">2</span>]</span>
<span id="cb12-7"><a></a>}</span>
<span id="cb12-8"><a></a></span>
<span id="cb12-9"><a></a><span class="co"># using library(purrr) functional primitives:</span></span>
<span id="cb12-10"><a></a><span class="co"># df &lt;- pr_p |&gt; map_dfr(\(y) coef(lm(y ~ d$height_c)))</span></span>
<span id="cb12-11"><a></a></span>
<span id="cb12-12"><a></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(height_c, weight), <span class="at">data =</span> d)</span>
<span id="cb12-13"><a></a>p <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">20</span>, <span class="dv">90</span>) <span class="sc">+</span> </span>
<span id="cb12-14"><a></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> slopes, </span>
<span id="cb12-15"><a></a>              <span class="at">intercept =</span> intercepts, </span>
<span id="cb12-16"><a></a>              <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb12-17"><a></a>  <span class="fu">ylab</span>(<span class="st">"Weight (kg)"</span>) <span class="sc">+</span> </span>
<span id="cb12-18"><a></a>  <span class="fu">xlab</span>(<span class="st">"Centered Height (cm)"</span>) <span class="sc">+</span></span>
<span id="cb12-19"><a></a>  <span class="fu">ggtitle</span>(<span class="st">"Kalahari !Kung San people"</span>, </span>
<span id="cb12-20"><a></a>          <span class="at">subtitle =</span> <span class="st">"Prior predictive simulation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-8-1.png" class="quarto-figure quarto-figure-center" width="384"></p>
</figure>
</div>
</div>
</div></div>
</div>
<div>
<ul>
<li class="fragment"><a href="https://www.polleverywhere.com/free_text_polls/ktA65I0m27uUAnCn44Cui">What do you notice about this prior?</a></li>
</ul>
</div>
</section>
<section id="deriving-a-posterior-distribution" class="slide level2 smaller">
<h2>Deriving a Posterior Distribution</h2>
<div>
<ul>
<li class="fragment">We have seen how to derive the posterior and posterior predictive distribution</li>
<li class="fragment">Three dimentional posterior: <span class="math inline">\(f(\alpha, \beta, \sigma)\)</span>. <a href="https://www.polleverywhere.com/free_text_polls/Uj05I36LJbqhNiOylx6Wa">What happened</a> to <span class="math inline">\(\mu\)</span>?</li>
<li class="fragment">We construct the posterior from the prior and data likelihood (for each <span class="math inline">\(y_i\)</span>): <span class="math display">\[
\begin{eqnarray}
&amp;\text{Prior: }f(\alpha, \beta, \sigma) = f_1(\alpha) f_2(\beta) f_3(\sigma) \\
&amp;\text{Likelihood: }f(y \mid \alpha, \beta, \sigma) = \prod_{i=1}^{n}f_4(y_i \mid \alpha, \beta, \sigma) \\
&amp;\text{Posterior: }f(\alpha,\beta,\sigma \mid y) = \frac{f_1(\alpha) f(_2\beta) f_3(\sigma) \cdot \left[\prod_{i=1}^{n}f_4(y_i \mid \alpha, \beta, \sigma) \right]}
{\int\int\int f_1(\alpha) f_2(\beta) f_3(\sigma) \cdot \left[\prod_{i=1}^{n}f_4(y_i \mid \alpha, \beta, \sigma) \right] d\alpha \, d\beta \, d\sigma}
\end{eqnarray}
\]</span></li>
<li class="fragment">To be more precise, we would indicate that <span class="math inline">\(f_1, f_2\)</span> and <span class="math inline">\(f_4\)</span> are Normal with different parameters, and <span class="math inline">\(f_3\)</span> is <span class="math inline">\(\text{Exp}(0.2)\)</span></li>
</ul>
</div>
</section>
<section id="fitting-the-model" class="slide level2 smaller">
<h2>Fitting the Model</h2>
<div>
<ul>
<li class="fragment">Even though our prior is slightly off, 300+ observations is a lot in this case (big data!), and so we proceed to model fitting</li>
<li class="fragment">We will use <code>stan_glm()</code> function in <code>rstanarm</code></li>
<li class="fragment"><code>rstanarm</code> has default priors, but you should specify your own:</li>
</ul>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb13-2"><a></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb13-3"><a></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb13-4"><a></a></span>
<span id="cb13-5"><a></a>m1 <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(</span>
<span id="cb13-6"><a></a>  weight <span class="sc">~</span> height_c,</span>
<span id="cb13-7"><a></a>  <span class="at">data =</span> d,</span>
<span id="cb13-8"><a></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb13-9"><a></a>  <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">60</span>, <span class="dv">10</span>),</span>
<span id="cb13-10"><a></a>  <span class="at">prior =</span> <span class="fu">normal</span>(<span class="fl">0.55</span>, <span class="fl">0.1</span>),</span>
<span id="cb13-11"><a></a>  <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="fl">0.2</span>),</span>
<span id="cb13-12"><a></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb13-13"><a></a>  <span class="at">iter =</span> <span class="dv">500</span>,</span>
<span id="cb13-14"><a></a>  <span class="at">seed =</span> <span class="dv">1234</span></span>
<span id="cb13-15"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li class="fragment">By default, <code>rstanarm</code> samples from the posterior. To get back the prior predictive distribution (instead of doing it in R) use <code>prior_PD = TRUE</code></li>
</ul>
</div>
</section>
<section id="looking-at-the-model-summary" class="slide level2 smaller">
<h2>Looking at the Model Summary</h2>
<div class="fragment">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a></a><span class="fu">summary</span>(m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Model Info:

 function:     stan_glm
 family:       gaussian [identity]
 formula:      weight ~ height_c
 algorithm:    sampling
 sample:       1000 (posterior sample size)
 priors:       see help('prior_summary')
 observations: 352
 predictors:   2

Estimates:
              mean   sd   10%   50%   90%
(Intercept) 45.0    0.2 44.7  45.0  45.3 
height_c     0.6    0.0  0.6   0.6   0.7 
sigma        4.2    0.2  4.0   4.2   4.5 

Fit Diagnostics:
           mean   sd   10%   50%   90%
mean_PPD 45.0    0.3 44.6  45.0  45.4 

The mean_ppd is the sample average posterior predictive distribution of the outcome variable (for details see help('summary.stanreg')).

MCMC diagnostics
              mcse Rhat n_eff
(Intercept)   0.0  1.0  824  
height_c      0.0  1.0  994  
sigma         0.0  1.0  867  
mean_PPD      0.0  1.0  970  
log-posterior 0.1  1.0  459  

For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).</code></pre>
</div>
</div>
</div>
<div>
<ul>
<li class="fragment">If you can examine the priors by running <code>prior_summary(m1)</code></li>
</ul>
</div>
</section>
<section id="evaluting-quality-of-the-inferences" class="slide level2 smaller">
<h2>Evaluting Quality of the Inferences</h2>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a></a><span class="fu">neff_ratio</span>(m1) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    height_c       sigma 
       0.82        0.99        0.87 </code></pre>
</div>
</div>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a></a><span class="fu">rhat</span>(m1) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    height_c       sigma 
          1           1           1 </code></pre>
</div>
</div>
</div>
<div class="fragment">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a></a><span class="fu">mcmc_trace</span>(m1, <span class="at">size =</span> <span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-14-1.png" class="quarto-figure quarto-figure-center" width="1152"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="same-model-in-stan" class="slide level2 smaller">
<h2>Same Model in Stan</h2>
<div class="fragment">
<div class="cell" data-output.var="stan1">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb21-1"><a></a><span class="kw">data</span> {</span>
<span id="cb21-2"><a></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb21-3"><a></a>  <span class="dt">vector</span>[N] x;</span>
<span id="cb21-4"><a></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb21-5"><a></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt; prior_PD;</span>
<span id="cb21-6"><a></a>}</span>
<span id="cb21-7"><a></a><span class="kw">parameters</span> {</span>
<span id="cb21-8"><a></a>  <span class="dt">real</span> alpha;</span>
<span id="cb21-9"><a></a>  <span class="dt">real</span> beta;</span>
<span id="cb21-10"><a></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb21-11"><a></a>}</span>
<span id="cb21-12"><a></a><span class="kw">transformed parameters</span> {</span>
<span id="cb21-13"><a></a>  <span class="dt">vector</span>[N] mu = alpha + beta * x;</span>
<span id="cb21-14"><a></a>}</span>
<span id="cb21-15"><a></a><span class="kw">model</span> {</span>
<span id="cb21-16"><a></a>  alpha ~ normal(<span class="dv">60</span>, <span class="dv">10</span>);</span>
<span id="cb21-17"><a></a>  beta ~ normal(<span class="fl">0.55</span>, <span class="fl">0.1</span>);</span>
<span id="cb21-18"><a></a>  sigma ~ exponential(<span class="fl">0.2</span>);</span>
<span id="cb21-19"><a></a>  <span class="cf">if</span> (!prior_PD) {</span>
<span id="cb21-20"><a></a>    y ~ normal(mu, sigma);</span>
<span id="cb21-21"><a></a>  }</span>
<span id="cb21-22"><a></a>}</span>
<span id="cb21-23"><a></a><span class="kw">generated quantities</span> {</span>
<span id="cb21-24"><a></a>  <span class="dt">array</span>[N] <span class="dt">real</span> yrep = normal_rng(mu, sigma);</span>
<span id="cb21-25"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div>
<ul>
<li class="fragment">You can pass <code>prior_PD</code> as a flag to enable drawing from the prior predictive distribution</li>
</ul>
</div>
</section>
<section id="prior-vs-posterior" class="slide level2 smaller">
<h2>Prior vs Posterior</h2>
<div>
<ul>
<li class="fragment">Comparing the prior to the posterior tells us how much the model learned from data</li>
<li class="fragment">It also helps us to validate if our priors were reasonable</li>
<li class="fragment">In <code>rstanarm</code>, you can use the <code>posterior_vs_prior</code> function</li>
</ul>
</div>
<div class="fragment">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-16-1.png" class="quarto-figure quarto-figure-center" width="1152"></p>
</figure>
</div>
</div>
</div>
</div>
<div>
<ul>
<li class="fragment">Your prior should cover the plausible range of parameter values</li>
<li class="fragment">When we don’t have a lot of data and parameters are complex, setting good priors takes work, but there are <a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations">guidelines</a></li>
</ul>
</div>
</section>
<section id="examining-the-posterior" class="slide level2 smaller">
<h2>Examining the Posterior</h2>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb22-2"><a></a></span>
<span id="cb22-3"><a></a>draws <span class="ot">&lt;-</span> <span class="fu">spread_draws</span>(m1, <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, height_c, sigma)</span>
<span id="cb22-4"><a></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(<span class="fu">round</span>(draws, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: right;">.chain</th>
<th style="text-align: right;">.iteration</th>
<th style="text-align: right;">.draw</th>
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">height_c</th>
<th style="text-align: right;">sigma</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">44.97</td>
<td style="text-align: right;">0.62</td>
<td style="text-align: right;">4.09</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">45.06</td>
<td style="text-align: right;">0.61</td>
<td style="text-align: right;">4.21</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">45.02</td>
<td style="text-align: right;">0.63</td>
<td style="text-align: right;">4.13</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">45.07</td>
<td style="text-align: right;">0.64</td>
<td style="text-align: right;">4.32</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">44.66</td>
<td style="text-align: right;">0.64</td>
<td style="text-align: right;">4.38</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">45.31</td>
<td style="text-align: right;">0.62</td>
<td style="text-align: right;">4.12</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div>
<ul>
<li class="fragment"><code>spread_draws</code> will arrange the inferences in columns (wide format)</li>
<li class="fragment"><code>gather_draws</code> will arrange the inferences in rows (long format), which is usually more convenient for plotting and computation</li>
</ul>
</div>
</section>
<section id="examining-the-posterior-1" class="slide level2 smaller">
<h2>Examining the Posterior</h2>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb23-2"><a></a>draws <span class="ot">&lt;-</span> <span class="fu">gather_draws</span>(m1, <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, height_c, sigma)</span>
<span id="cb23-3"><a></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">tail</span>(draws, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: right;">.chain</th>
<th style="text-align: right;">.iteration</th>
<th style="text-align: right;">.draw</th>
<th style="text-align: left;">.variable</th>
<th style="text-align: right;">.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">247</td>
<td style="text-align: right;">997</td>
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">4.09</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">248</td>
<td style="text-align: right;">998</td>
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">4.22</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">249</td>
<td style="text-align: right;">999</td>
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">4.20</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">250</td>
<td style="text-align: right;">1000</td>
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">4.11</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a></a>draws <span class="sc">|&gt;</span> <span class="fu">mean_qi</span>(<span class="at">.width =</span> <span class="fl">0.90</span>) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>() <span class="co"># also see ?median_qi(), etc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;">.variable</th>
<th style="text-align: right;">.value</th>
<th style="text-align: right;">.lower</th>
<th style="text-align: right;">.upper</th>
<th style="text-align: right;">.width</th>
<th style="text-align: left;">.point</th>
<th style="text-align: left;">.interval</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">45.000</td>
<td style="text-align: right;">44.635</td>
<td style="text-align: right;">45.36</td>
<td style="text-align: right;">0.9</td>
<td style="text-align: left;">mean</td>
<td style="text-align: left;">qi</td>
</tr>
<tr class="even">
<td style="text-align: left;">height_c</td>
<td style="text-align: right;">0.624</td>
<td style="text-align: right;">0.576</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.9</td>
<td style="text-align: left;">mean</td>
<td style="text-align: left;">qi</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">4.250</td>
<td style="text-align: right;">3.996</td>
<td style="text-align: right;">4.53</td>
<td style="text-align: right;">0.9</td>
<td style="text-align: left;">mean</td>
<td style="text-align: left;">qi</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div>
<ul>
<li class="fragment">From the above table: <span class="math inline">\(\E(y \mid x^c) (\text{kg}) = 45 (\text{kg}) + 0.62 (\text{kg/cm}) \cdot x^c (\text{cm})\)</span></li>
</ul>
</div>
</section>
<section id="variability-in-parameter-inferences" class="slide level2 smaller">
<h2>Variability in Parameter Inferences</h2>
<div>
<ul>
<li class="fragment">The code in section 9.4 in the book doesn’t work as the function and variable names have changed</li>
</ul>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a></a>dpred <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb25-2"><a></a>  <span class="co"># same as add_epred_draws for lin reg not for other GLMs</span></span>
<span id="cb25-3"><a></a>  <span class="fu">add_linpred_draws</span>(m1, <span class="at">ndraws =</span> <span class="dv">50</span>)</span>
<span id="cb25-4"><a></a><span class="fu">head</span>(dpred, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 10
# Groups:   height, weight, age, male, height_c, .row [1]
  height weight   age  male height_c  .row .chain .iteration .draw .linpred
   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;      &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;
1   152.   47.8    63     1    -2.83     1     NA         NA     1     43.3
2   152.   47.8    63     1    -2.83     1     NA         NA     2     42.9
3   152.   47.8    63     1    -2.83     1     NA         NA     3     43.0</code></pre>
</div>
</div>
</div>
<div class="fragment">
<div class="cell columns column-output-location" data-layout-align="center">
<div class="column">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a></a>p <span class="ot">&lt;-</span> dpred <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> height_c, <span class="at">y =</span> weight)) <span class="sc">+</span></span>
<span id="cb27-2"><a></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .linpred, <span class="at">group =</span> .draw), </span>
<span id="cb27-3"><a></a>            <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb27-4"><a></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d, <span class="at">size =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a></a>  <span class="fu">ylab</span>(<span class="st">"Weight (kg)"</span>) <span class="sc">+</span> </span>
<span id="cb27-6"><a></a>  <span class="fu">xlab</span>(<span class="st">"Centered Height (cm)"</span>) <span class="sc">+</span></span>
<span id="cb27-7"><a></a>  <span class="fu">ggtitle</span>(<span class="st">"100 draws from the slope/intercept posterior"</span>)</span>
<span id="cb27-8"><a></a><span class="fu">print</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column fragment">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-21-1.png" class="quarto-figure quarto-figure-center" width="384"></p>
</figure>
</div>
</div>
</div></div>
</div>
</section>
<section id="posterior-predictions" class="slide level2 smaller">
<h2>Posterior Predictions</h2>
<div>
<ul>
<li class="fragment">Suppose we are interested in predicting the weight of a person with a height of 160 cm</li>
<li class="fragment">This corresponds to the centered height of 5.4: (<span class="math inline">\(160 - \bar{x}\)</span>)</li>
<li class="fragment">We can now compute the distribution of the mean weight of a 160 cm person (reflecting variability in the slope and intercept only):
<ul>
<li class="fragment"><span class="math inline">\(\mu = \alpha + \beta \cdot 5.4\)</span>, for each posterior draw</li>
</ul></li>
<li class="fragment">And a predictive distribution:
<ul>
<li class="fragment"><span class="math inline">\(y_{\text{pred}}  \sim \text{Normal}(\mu, \sigma)\)</span></li>
</ul></li>
</ul>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a></a>draws <span class="ot">&lt;-</span> <span class="fu">spread_draws</span>(m1, <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, height_c, sigma)</span>
<span id="cb28-2"><a></a>draws <span class="ot">&lt;-</span> draws <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a></a>  <span class="fu">mutate</span>(<span class="at">mu =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span> <span class="sc">+</span> height_c <span class="sc">*</span> <span class="fl">5.4</span>,</span>
<span id="cb28-4"><a></a>         <span class="at">y_pred =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(draws), mu, sigma))</span>
<span id="cb28-5"><a></a>draws[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">8</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  `(Intercept)` height_c sigma    mu y_pred
          &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1          45.0    0.619  4.09  48.3   43.5
2          45.1    0.607  4.21  48.3   50.2
3          45.0    0.628  4.13  48.4   46.6</code></pre>
</div>
</div>
</div>
</section>
<section id="posterior-predictions-1" class="slide level2 smaller">
<h2>Posterior Predictions</h2>
<div>
<ul>
<li class="fragment">We can compare predictive and average densities</li>
<li class="fragment">Left panel showing the densities on their own</li>
<li class="fragment">Right panel showing the same densities in the context of raw observations</li>
</ul>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a></a>mqi <span class="ot">&lt;-</span> draws <span class="sc">|&gt;</span> <span class="fu">median_qi</span>(<span class="at">.width =</span> <span class="fl">0.90</span>)</span>
<span id="cb30-2"><a></a><span class="fu">select</span>(mqi, <span class="fu">contains</span>(<span class="fu">c</span>(<span class="st">'mu'</span>, <span class="st">'y_pred'</span>))) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    mu mu.lower mu.upper y_pred y_pred.lower y_pred.upper
1 48.4     47.9     48.8   48.2         41.2         55.2</code></pre>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<div class="fragment">
<div class="cell">
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-24-1.png" width="480"></p>
</figure>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:50%;">
<div class="fragment">
<div class="cell">
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-25-1.png" width="480"></p>
</figure>
</div>
</div>
</div>
</div>
</div></div>
</section>
<section id="rstanarm-prediction-functions" class="slide level2">
<h2>RStanArm Prediction Functions</h2>
<div>
<ul>
<li class="fragment"><code>posterior_linpred</code> returns <span class="math inline">\(D \times N\)</span> matrix with D draws and N data points
<ul>
<li class="fragment"><span class="math inline">\(\eta_n = \alpha + \sum_{p=1}^P \beta_p x_{np}\)</span>, where <span class="math inline">\(P\)</span> is the total number of regression inputs</li>
</ul></li>
<li class="fragment"><code>posterior_epred</code> returns an <span class="math inline">\(D \times N\)</span> matrix that applies the inverse link (in GLMs) to the linear predictor <span class="math inline">\(\eta\)</span>
<ul>
<li class="fragment"><span class="math inline">\(\mu_n = \E(y | x_n)\)</span>; this is the same as <span class="math inline">\(\eta\)</span> in Lin Regression</li>
</ul></li>
<li class="fragment"><code>posterior_predict</code> returns an <span class="math inline">\(D \times N\)</span> matrix of predictions: <span class="math inline">\(y \mid \mu_n\)</span></li>
</ul>
</div>
</section>
<section id="predictions-in-rstanarm" class="slide level2 smaller">
<h2>Predictions in RStanArm</h2>
<div>
<ul>
<li class="fragment">Posterior linear predictor</li>
</ul>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a></a>eta <span class="ot">&lt;-</span> <span class="fu">posterior_linpred</span>(m1, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">height_c =</span> <span class="fl">5.4</span>))</span>
<span id="cb32-2"><a></a><span class="fu">quantile</span>(eta, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.50</span>, <span class="fl">0.95</span>)) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5%  50%  95% 
47.9 48.4 48.8 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a></a>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'From the R simulation, 90% interval for eta = [{mqi$mu.lower |&gt; round(2)}, {mqi$mu.upper |&gt; round(2)}]'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>From the R simulation, 90% interval for eta = [47.91, 48.82]</code></pre>
</div>
</div>
</div>
<ul>
<li class="fragment">Posterior conditional mean</li>
</ul>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a></a>mu <span class="ot">&lt;-</span> <span class="fu">posterior_epred</span>(m1, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">height_c =</span> <span class="fl">5.4</span>))</span>
<span id="cb36-2"><a></a><span class="fu">quantile</span>(mu, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.50</span>, <span class="fl">0.95</span>)) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5%  50%  95% 
47.9 48.4 48.8 </code></pre>
</div>
</div>
</div>
<ul>
<li class="fragment">Posterior prediction</li>
</ul>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a></a>y_pred <span class="ot">&lt;-</span> <span class="fu">posterior_predict</span>(m1, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">height_c =</span> <span class="fl">5.4</span>))</span>
<span id="cb38-2"><a></a><span class="fu">quantile</span>(y_pred, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.50</span>, <span class="fl">0.95</span>)) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5%  50%  95% 
41.6 48.5 55.0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a></a>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'From the R simulation, 90% interval for y_pred = [{mqi$y_pred.lower |&gt; round(2)}, {mqi$y_pred.upper |&gt; round(2)}]'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>From the R simulation, 90% interval for y_pred = [41.24, 55.25]</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="evaluting-model-quality" class="slide level2 smaller">
<h2>Evaluting Model Quality</h2>
<p><br> <br></p>

<img data-src="images/data-quality.png" class="quarto-figure quarto-figure-center r-stretch"></section>
<section id="evaluating-quality-of-the-model" class="slide level2 smaller">
<h2>Evaluating Quality of the Model</h2>
<div>
<ul>
<li class="fragment">There are at least two stages of model evaluation: 1) the quality of the draws and 2) the quality of predictions</li>
<li class="fragment">There is also a question of model fairness
<ul>
<li class="fragment">How were the data collected?</li>
<li class="fragment">People will likely interpret the results causally, even if not appropriate</li>
<li class="fragment">How will the model be used?</li>
<li class="fragment">Example: Correctional Offender Management Profiling for Alternative Sanctions (<a href="https://en.wikipedia.org/wiki/COMPAS_(software)">COMPAS</a>)</li>
</ul></li>
<li class="fragment">Just because the draws have good statistical properties (e.g., good mixing, low auto-correlation, etc.), it does not mean the model will perform well</li>
<li class="fragment">Model performance is assessed on how well it can make predictions, minimize costs and/or maximize benefits. Predictive accuracy is a common way of evaluating model performance.</li>
</ul>
</div>
</section>
<section id="evaluating-quality-of-the-model-1" class="slide level2 smaller scrollable">
<h2>Evaluating Quality of the Model</h2>
<div>
<ul>
<li class="fragment">Once we are satisfied that the draws are statistically well-behaved, we can focus on evaluating predictive performance</li>
<li class="fragment">We typically care about predictive performance out-of-sample</li>
<li class="fragment">In general, a good model is well-calibrated and makes sharp predictions (Gneiting et al.&nbsp;2007)<sup>1</sup></li>
<li class="fragment">For in-sample assessment, we perform Posterior Predictive Checks or PPCs</li>
<li class="fragment">To assess out-of-sample performance, we rely on cross-validation or its approximations</li>
<li class="fragment">If you are making causal (counterfactual) predictions, naive cross-validation will not work. Why?</li>
</ul>
</div>
<aside><ol class="aside-footnotes"><li id="fn1"><p>Gneiting, T., Balabdaoui, F., and Raftery, A. E. (2007) Probabilistic forecasts, calibration and sharpness. Journal of the Royal Statistical Society: Series B (Statistical Methodology), 69(2), 243–268.</p></li></ol></aside></section>
<section id="model-evaluation" class="slide level2 smaller">
<h2>Model Evaluation</h2>
<p>Here is the high-level plan of attack:</p>
<div>
<ul>
<li class="fragment">Fit a linear model to the full !Kung dataset (not just adults) and let <code>RStanArm</code> pick the priors (don’t do this at home)</li>
<li class="fragment">We know that this model is not quite right</li>
<li class="fragment">Evaluate the model fit</li>
<li class="fragment">Fix the model by thinking about the relationship between height and weight</li>
<li class="fragment">Evaluate the improved model</li>
<li class="fragment">Compare the linear model to the improved model</li>
</ul>
</div>
</section>
<section id="model-evaluation-1" class="slide level2 smaller">
<h2>Model Evaluation</h2>
<div>
<ul>
<li class="fragment">The following fits a linear model to the full dataset (not just adults)</li>
</ul>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a></a>m2 <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(</span>
<span id="cb42-2"><a></a>  weight <span class="sc">~</span> height,</span>
<span id="cb42-3"><a></a>  <span class="at">data =</span> d,</span>
<span id="cb42-4"><a></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb42-5"><a></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb42-6"><a></a>  <span class="at">iter =</span> <span class="dv">600</span>,</span>
<span id="cb42-7"><a></a>  <span class="at">seed =</span> <span class="dv">1234</span></span>
<span id="cb42-8"><a></a>)</span>
<span id="cb42-9"><a></a><span class="fu">summary</span>(m2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div>
<ul>
<li class="fragment">There were no sampling problems</li>
<li class="fragment">And posterior draws look well-behaved</li>
<li class="fragment">But how good is this model?</li>
</ul>
</div>
<div class="fragment">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Model Info:

 function:     stan_glm
 family:       gaussian [identity]
 formula:      weight ~ height
 algorithm:    sampling
 sample:       1200 (posterior sample size)
 priors:       see help('prior_summary')
 observations: 544
 predictors:   2

Estimates:
              mean   sd    10%   50%   90%
(Intercept) -33.8    1.1 -35.1 -33.7 -32.4
height        0.5    0.0   0.5   0.5   0.5
sigma         5.0    0.1   4.8   5.0   5.2

Fit Diagnostics:
           mean   sd   10%   50%   90%
mean_PPD 35.6    0.3 35.2  35.6  36.0 

The mean_ppd is the sample average posterior predictive distribution of the outcome variable (for details see help('summary.stanreg')).

MCMC diagnostics
              mcse Rhat n_eff
(Intercept)   0.0  1.0  1198 
height        0.0  1.0  1228 
sigma         0.0  1.0   836 
mean_PPD      0.0  1.0  1126 
log-posterior 0.1  1.0   497 

For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).</code></pre>
</div>
</div>
</div>
</section>
<section id="visual-posterior-predictive-checks" class="slide level2 smaller">
<h2>Visual Posterior Predictive Checks</h2>
<div>
<ul>
<li class="fragment">The idea behind PPCs is to compare the distribution of the observation to posterior predictions</li>
<li class="fragment">We already saw an example of how to do it by hand</li>
<li class="fragment">Here, we will do using functions in <code>RStanArm</code></li>
</ul>
</div>
<div class="fragment">
<div class="cell columns column-output-location" data-layout-align="center">
<div class="column">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb44-2"><a></a><span class="co"># bayesplot::pp_check(m2) &lt;-- shortcut</span></span>
<span id="cb44-3"><a></a></span>
<span id="cb44-4"><a></a><span class="co"># predict for every observed point</span></span>
<span id="cb44-5"><a></a>yrep <span class="ot">&lt;-</span> <span class="fu">posterior_predict</span>(m2) </span>
<span id="cb44-6"><a></a></span>
<span id="cb44-7"><a></a><span class="co"># select 50 draws at random</span></span>
<span id="cb44-8"><a></a>s <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(yrep), <span class="dv">50</span>)</span>
<span id="cb44-9"><a></a></span>
<span id="cb44-10"><a></a><span class="co"># plot data against predictive densities</span></span>
<span id="cb44-11"><a></a><span class="fu">ppc_dens_overlay</span>(d<span class="sc">$</span>weight, yrep[s, ]) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-32-1.png" class="quarto-figure quarto-figure-center" width="432"></p>
</figure>
</div>
</div>
</div></div>
</div>
</section>
<section id="visual-posterior-predictive-checks-1" class="slide level2 smaller">
<h2>Visual Posterior Predictive Checks</h2>
<div>
<ul>
<li class="fragment">We can also compute the distributions of test statistics:<br>
</li>
</ul>
</div>
<div class="fragment">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb45-2"><a></a>p1 <span class="ot">&lt;-</span> <span class="fu">ppc_stat</span>(d<span class="sc">$</span>weight, yrep, <span class="at">stat =</span> <span class="st">"mean"</span>); p2 <span class="ot">&lt;-</span> <span class="fu">ppc_stat</span>(d<span class="sc">$</span>weight, yrep, <span class="at">stat =</span> <span class="st">"sd"</span>)</span>
<span id="cb45-3"><a></a>q25 <span class="ot">&lt;-</span> <span class="cf">function</span>(y) <span class="fu">quantile</span>(y, <span class="fl">0.25</span>); q75 <span class="ot">&lt;-</span> <span class="cf">function</span>(y) <span class="fu">quantile</span>(y, <span class="fl">0.75</span>)</span>
<span id="cb45-4"><a></a>p3 <span class="ot">&lt;-</span> <span class="fu">ppc_stat</span>(d<span class="sc">$</span>weight, yrep, <span class="at">stat =</span> <span class="st">"q25"</span>); p4 <span class="ot">&lt;-</span> <span class="fu">ppc_stat</span>(d<span class="sc">$</span>weight, yrep, <span class="at">stat =</span> <span class="st">"q75"</span>); </span>
<span id="cb45-5"><a></a><span class="fu">grid.arrange</span>(p1, p2, p3, p4, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-33-1.png" class="quarto-figure quarto-figure-center" width="1056"></p>
</figure>
</div>
</div>
</div>
</div>
<div>
<ul>
<li class="fragment"><code>ppc_stat</code> is a shorthand for computation on each posterior (predictive) draw</li>
<li class="fragment">For example, <code>ppc_stat(d$weight, yrep, stat = "mean")</code> is equivalent to:
<ul>
<li class="fragment">Setting <span class="math inline">\(T(y) = \text{mean(d\$weight)}\)</span> and <span class="math inline">\(T_{\text{yrep}} = \text{rowMeans(yrep)}\)</span></li>
</ul></li>
</ul>
</div>
</section>
<section id="visual-posterior-predictive-checks-2" class="slide level2 smaller">
<h2>Visual Posterior Predictive Checks</h2>
<div>
<ul>
<li class="fragment">Since we have a distribution at each observation point, we can plot the predictive distribution at each observation</li>
<li class="fragment">We will first randomly select a subset of 50 people</li>
<li class="fragment">Each column of <code>yrep</code> is a prediction for each observation point</li>
</ul>
</div>
<div class="fragment">
<div class="cell columns column-output-location" data-layout-align="center">
<div class="column">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a></a>s <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">ncol</span>(yrep), <span class="dv">50</span>)</span>
<span id="cb46-2"><a></a></span>
<span id="cb46-3"><a></a>bayesplot<span class="sc">::</span><span class="fu">ppc_intervals</span>(</span>
<span id="cb46-4"><a></a>  d<span class="sc">$</span>weight[s],</span>
<span id="cb46-5"><a></a>  <span class="at">yrep =</span> yrep[, s],</span>
<span id="cb46-6"><a></a>  <span class="at">x =</span> d<span class="sc">$</span>height[s],</span>
<span id="cb46-7"><a></a>  <span class="at">prob =</span> <span class="fl">0.5</span>,</span>
<span id="cb46-8"><a></a>  <span class="at">prob_outer =</span> <span class="fl">0.90</span></span>
<span id="cb46-9"><a></a>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Height (cm)"</span>)  <span class="sc">+</span> </span>
<span id="cb46-10"><a></a>  <span class="fu">ylab</span>(<span class="st">"Weight (kg)"</span>) <span class="sc">+</span></span>
<span id="cb46-11"><a></a>  <span class="fu">ggtitle</span>(<span class="st">"Predicted vs observed weight"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-34-1.png" class="quarto-figure quarto-figure-center" width="576"></p>
</figure>
</div>
</div>
</div></div>
</div>
</section>
<section id="quantifying-model-accuracy" class="slide level2 smaller scrollable">
<h2>Quantifying Model Accuracy</h2>
<div class="columns">
<div class="column" style="width:60%;">
<div>
<ul>
<li class="fragment">We looked at some visual evidence for in-sample model accuracy</li>
<li class="fragment">The model is clearly doing a poor job of capturing observed data, particularly in the lower quantiles of the predictive distribution</li>
<li class="fragment">In a situation like this, we would typically proceed to model improvements</li>
<li class="fragment">Often, the model is not as bad as this one, and we would like to get some quantitative measures of model fit<sup>1</sup></li>
<li class="fragment">We do this so we can assess the relative performance of the next set of models</li>
</ul>
</div>
</div><div class="column" style="width:40%;">
<div class="fragment">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/loo.png" class="quarto-figure quarto-figure-center"></p>
</figure>
</div>
</div>
</div></div>
<aside><ol class="aside-footnotes"><li id="fn2"><p>Vehtari, A., Gelman, A., &amp; Gabry, J. (2017). <a href="https://mc-stan.org/loo/index.html">Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC</a>. Statistics and Computing, 27(5), 1413–1432. https://doi.org/10.1007/s11222-016-9696-4</p></li></ol></aside></section>
<section id="quantifying-model-accuracy-1" class="slide level2 smaller">
<h2>Quantifying Model Accuracy</h2>
<div>
<ul>
<li class="fragment">One way to assess model accuracy is to compute an average square deviation from point prediction: mean square error
<ul>
<li class="fragment"><span class="math inline">\(\text{RMSE} = \sqrt{\frac{1}{N} \sum_{n=1}^{N} (y_n - \E(y_n|\theta))^2}\)</span></li>
<li class="fragment">Or its scaled version, which divides the summand by <span class="math inline">\(\V(y_i | \theta)\)</span></li>
</ul></li>
<li class="fragment">These measures do not work well for non-normal models</li>
<li class="fragment">On the plus side, it is intuitive (why?) and computation is easy</li>
<li class="fragment">Note that if we just average the errors, we will get zero by definition</li>
</ul>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a></a><span class="co"># avarage error</span></span>
<span id="cb47-2"><a></a><span class="fu">mean</span>(d<span class="sc">$</span>weight <span class="sc">-</span> <span class="fu">colMeans</span>(yrep)) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.01</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a></a><span class="co"># root mean square error</span></span>
<span id="cb49-2"><a></a><span class="fu">mean</span>((d<span class="sc">$</span>weight <span class="sc">-</span> <span class="fu">colMeans</span>(yrep))<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span> <span class="fu">sqrt</span>() <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.98</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a></a><span class="co"># your book reports median absolute error</span></span>
<span id="cb51-2"><a></a><span class="fu">median</span>(<span class="fu">abs</span>(d<span class="sc">$</span>weight <span class="sc">-</span> <span class="fu">colMeans</span>(yrep)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.58</code></pre>
</div>
</div>
</div>
</section>
<section id="quantifying-model-accuracy-2" class="slide level2 smaller">
<h2>Quantifying Model Accuracy</h2>
<div>
<ul>
<li class="fragment">In a probabilistic prediction, we can assess model calibration</li>
<li class="fragment">Calibration says that, for example, 50% intervals contain approximately 50% of the observations, and so on</li>
<li class="fragment">A well-calibrated model may still be a bad model (see below) as the uncertainty may be too wide; for two models with the same calibration, we prefer the one with lower uncertainty</li>
</ul>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a></a>inside <span class="ot">&lt;-</span> <span class="cf">function</span>(y, obs) <span class="fu">return</span>(obs <span class="sc">&gt;=</span> y[<span class="dv">1</span>] <span class="sc">&amp;</span> obs <span class="sc">&lt;=</span> y[<span class="dv">2</span>])</span>
<span id="cb53-2"><a></a>calib  <span class="ot">&lt;-</span> <span class="cf">function</span>(y, data, interval) {</span>
<span id="cb53-3"><a></a>  mid <span class="ot">&lt;-</span> interval <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb53-4"><a></a>  l <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">-</span> mid; u <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> mid</span>
<span id="cb53-5"><a></a>  intervals <span class="ot">&lt;-</span> <span class="fu">apply</span>(y, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fu">c</span>(l, u))</span>
<span id="cb53-6"><a></a>  is_inside <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">ncol</span>(intervals))</span>
<span id="cb53-7"><a></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(intervals)) {</span>
<span id="cb53-8"><a></a>    is_inside[i] <span class="ot">&lt;-</span> <span class="fu">inside</span>(intervals[, i], data[i])</span>
<span id="cb53-9"><a></a>  }</span>
<span id="cb53-10"><a></a> <span class="fu">return</span>(<span class="fu">mean</span>(is_inside))</span>
<span id="cb53-11"><a></a>}</span>
<span id="cb53-12"><a></a><span class="fu">calib</span>(yrep, d<span class="sc">$</span>weight, <span class="fl">0.50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.478</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a></a><span class="fu">calib</span>(yrep, d<span class="sc">$</span>weight, <span class="fl">0.90</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.912</code></pre>
</div>
</div>
</div>
</section>
<section id="quantifying-model-accuracy-3" class="slide level2 smaller">
<h2>Quantifying Model Accuracy</h2>
<div>
<ul>
<li class="fragment">A popular “proper” scoring rule for probabilistic prediction is log score</li>
<li class="fragment">This is equivalent to the log predictive density <span class="math inline">\(\log f(y \mid \theta)\)</span></li>
<li class="fragment">We would like to estimate the model’s ability to predict data it has not seen, even though we do not observe the true data-generating process</li>
<li class="fragment">This quantity is approximated by log-pointwise-predictive-density <span class="math display">\[
\text{lppd} = \sum_{n=1}^{N} \log \left( \frac{1}{S} \sum_{s=1}^{S} f(y_n \mid \theta_{-n, s}) \right)
\]</span></li>
<li class="fragment">To compute this quantity, fit the model N times, dropping one point at a time (-n)</li>
<li class="fragment">S is the number of posterior samples, and <span class="math inline">\(\theta_{-n, s}\)</span>, is the s-th sample without the n-th data point</li>
<li class="fragment"><a href="https://arxiv.org/abs/1507.04544">PSIS-LOO</a> (Pareto Smoothed Importance Sampling, Vehtari et al, 2017) provides a computationally efficient way to approximate LOO, without refitting the model N times</li>
</ul>
</div>
</section>
<section id="quantifying-model-accuracy-4" class="slide level2 smaller">
<h2>Quantifying Model Accuracy</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a></a><span class="fu">library</span>(loo)</span>
<span id="cb57-2"><a></a>lm2 <span class="ot">&lt;-</span> <span class="fu">loo</span>(m2)</span>
<span id="cb57-3"><a></a>lm2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 1200 by 544 log-likelihood matrix.

         Estimate   SE
elpd_loo  -1648.7 14.3
p_loo         3.0  0.3
looic      3297.3 28.6
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.6, 1.0]).

All Pareto k estimates are good (k &lt; 0.68).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a></a><span class="fu">plot</span>(lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>


<img data-src="05-lecture_files/figure-revealjs/unnamed-chunk-37-1.png" class="quarto-figure quarto-figure-center r-stretch" width="384"></section>

    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">
<p><a href="https://ericnovik.github.io/bayes-course.html" class="uri">https://ericnovik.github.io/bayes-course.html</a></p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="../../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': true,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":false,"chalkWidth":5},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp("https:\/\/ericnovik\.github\.io\/");
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>